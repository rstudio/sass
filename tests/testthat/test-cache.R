context("cache")

# Creates a temporary cache that is used as the default. When the calling
# function exits, the temporary cache is destroyed, and the previous default
# cache is restored.
local_temp_cache <- function(env = parent.frame()) {
  orig_cache <- sass_cache_get()
  temp_cache <- sass_file_cache(tempfile())
  withr::defer(
    {
      sass_cache_set(orig_cache)
      temp_cache$destroy()
    },
    envir = env
  )
  sass_cache_set(temp_cache)
}


test_that("throws on invalid output dir", {
  local_temp_cache()

  # Prime the cache
  sass("div { border: 1px solid black; }")

  # Cache
  expect_error(
    sass(
      "div { border: 1px solid black; }",
      output = file.path("not", "a", "path.css")
    )
  )
})

test_that("reads from and writes to cache", {
  local_temp_cache()
  expected <- read_utf8("test-unicode-var-expected.css")

  css <- sass(sass_file("test-unicode-var-input.scss"))
  expect_equal(as.character(css), expected)

  css <- sass(sass_file("test-unicode-var-input.scss"))
  expect_equal(as.character(css), expected)

  expect_equal(sass_cache_get()$size(), 1)
})

test_that("writes to cache", {
  local_temp_cache()
  cache <- sass_cache_get()

  input <- list(
    list(text_color = "#313131"),
    list("body { color: $text_color; }")
  )

  options <- sass_options(output_style = "compact")

  res <- sass(input, options)

  # Did we get the right result?
  expect_equal(as.character(res), "body { color: #313131; }\n")

  # Did a cache entry get added?
  expect_equal(cache$size(), 1)

  # Again, now with an output file
  out_file <- tempfile(fileext = ".css")
  sass(input, options, out_file)
  expect_equal(read_utf8(out_file), c("body { color: #313131; }\n"))

  # Now manipulate the cache directly to make sure it is actually being read
  # from. We'll change the value in the cache and see if sass() reads from it.
  cache$set_content(cache$keys(), "foo")
  res <- sass(input, options)
  expect_equal(as.character(res), "foo")
})

test_that("unicode characters work OK after caching", {
  local_temp_cache()
  expected <- read_utf8("test-unicode-var-expected.css")
  class(expected) <- c("css", "html", "character")
  attr(expected, "html") <- TRUE

  css <- sass(sass_file("test-unicode-var-input.scss"))
  expect_equal(css, expected)

  css <- sass(sass_file("test-unicode-var-input.scss"))
  expect_equal(css, expected)

  expect_equal(sass_cache_get()$size(), 1)
})

test_that("cache isn't written if a compilation error occurs", {
  local_temp_cache()

  input <- list(
    list(text_color = "#a0a0a0"),
    list("body { color is: $text_color; }")
  )
  options <- sass_options(output_style = "compact")

  expect_error(sass(input, options), "must be followed")

  expect_equal(sass_cache_get()$size(), 0)
})

test_that("cache key components", {
  tmpfile <- tempfile(fileext = ".tmp")
  file.create(tmpfile)
  old_mtime <- file.mtime(tmpfile)

  input <- list(sass_file(tmpfile))
  options <- sass_options()

  key1 <- sass_hash(list(input, options))
  while (file.mtime(tmpfile) == old_mtime) {
    # Force timestamp to change
    Sys.sleep(0.1)
    file.remove(tmpfile)
    file.create(tmpfile)
  }

  # Files differing by mtime should have different keys
  key2 <- sass_hash(list(input, options))
  expect_true(key1 != key2)

  # Options that are identical should have same key
  options3 <- sass_options()
  key3 <- sass_hash(list(input, options3))
  expect_true(key2 == key3)

  # Options that are different should have different keys
  options4 <- sass_options(output_style = "compact")
  key4 <- sass_hash(list(input, options4))
  expect_true(key3 != key4)
})



test_that("output_template() is cache and options aware", {
  local_temp_cache()

  input <- list(
    list(color = "red"),
    "body{color:red}"
  )
  opts <- sass_options(output_style = "compressed")
  expect_red <- function(file) {
    expect_equal(
      "body{color:red}",
      gsub("(\\s+)|(\t)|(;)", "", paste(readLines(file), collapse = ""))
    )
  }

  # File is exactly the same with the same input+options
  output1 <- sass(input, output = output_template(), options = opts)
  output2 <- sass(input, output = output_template(), options = opts)
  expect_true(output1 == output2)
  expect_match(output1, ".min.css$")
  expect_red(output1)
  expect_red(output2)

  # If cache is different, should get a different output file
  output3 <- sass(input, output = output_template(), options = opts, cache_key_extra = "foo")
  expect_true(output1 != output3)
  expect_red(output3)

  # Not minimized by default (because output_style = "expanded")
  output4 <- sass(input, output = output_template())
  expect_false(grepl(".min.css$", output4))
  expect_red(output4)

  # If no caching, should get a different output files
  output5 <- sass(input, output = output_template(), cache = NULL)
  output6 <- sass(input, output = output_template(), cache = NULL)
  expect_true(dirname(output5) != dirname(output6))
  expect_red(output5)
  expect_red(output6)
})

